# Техническое задание: RAG микросервис

## Обзор проекта

**Название**: RAG Crawl  
**Версия**: 0.1.0  
**Цель**: Микросервис для индексации документов и диалогового общения с использованием RAG (Retrieval Augmented Generation)

## Функциональные требования

### 1. Управление документами

#### 1.1 Загрузка документов
- **Входные форматы**: PDF, Word (.docx), текстовые файлы (.txt), Markdown (.md), HTML
- **Максимальный размер файла**: 100MB
- **Обязательные метаданные**:
  - `source_type`: тип источника (website, pdf, word, text, notion, gdrive, markdown)
  - `namespace`: пространство имен для группировки (например, домен сайта или название проекта)
  - `source_url`: URL источника (опционально)
  - `title`: название документа

#### 1.2 Обработка документов
- **Извлечение текста** из различных форматов
- **Разбиение на chunks**: размер 1024 токена с перекрытием 200 токенов
- **Дедупликация**: по хэшу содержимого документа
- **Векторизация**: через Azure OpenAI Embeddings (text-embedding-ada-002)

#### 1.3 Ресинхронизация
- **По namespace**: возможность обновить все документы в определенном пространстве имен
- **По отдельному документу**: обновление конкретного файла
- **Стратегия обновления**: 
  - Проверка хэша содержимого
  - Удаление старых chunks при изменении
  - Создание новых векторных представлений

### 2. Диалоговый интерфейс

#### 2.1 Чат-функционал
- **Интерфейс**: Gradio веб-приложение
- **Модель**: Azure OpenAI GPT-4
- **Retrieval**: топ-3 наиболее релевантных источника
- **Формат ответа**: 
  - Основной текст ответа
  - Список источников с ссылками на документы
  - Указание конкретных частей документов, откуда взята информация

#### 2.2 История чатов
- **Хранение**: все диалоги в PostgreSQL
- **Структура**: вопрос пользователя + ответ системы + использованные источники
- **Доступ**: просмотр истории через Gradio интерфейс

### 3. API Endpoints

#### 3.1 REST API для интеграции
```
POST /api/documents/upload          # Загрузка документа
GET  /api/documents                 # Список документов
PUT  /api/documents/{id}/resync     # Ресинхронизация документа
POST /api/documents/resync          # Ресинхронизация по namespace
DELETE /api/documents/{id}          # Удаление документа
POST /api/chat                      # Чат API
GET  /api/chat/history             # История чатов
GET  /api/health                   # Health check
```

## Технические требования

### Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Gradio UI     │    │   FastAPI        │    │   PostgreSQL    │
│   (Frontend)    │◄──►│   (Backend)      │◄──►│   (Metadata)    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │     Qdrant       │
                       │  (Vector Store)  │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │  Azure OpenAI    │
                       │ (LLM + Embeddings)│
                       └──────────────────┘
```

### Технологический стек

- **Python**: 3.11+
- **Управление зависимостями**: Poetry
- **Веб-фреймворк**: FastAPI
- **UI**: Gradio 4.7+
- **RAG Framework**: LlamaIndex 0.9+
- **Векторная БД**: Qdrant 1.6+
- **Реляционная БД**: PostgreSQL 15
- **LLM**: Azure OpenAI GPT-4
- **Embeddings**: Azure OpenAI text-embedding-ada-002
- **Контейнеризация**: Docker + Docker Compose

### Структура проекта

```
rag_crawl/
├── specs/                          # Техническая документация
├── src/rag_crawl/                  # Основной код приложения
│   ├── __init__.py
│   ├── config.py                   # Конфигурация приложения
│   ├── main.py                     # Точка входа FastAPI
│   ├── database/                   # Работа с БД
│   │   ├── models.py              # SQLAlchemy модели
│   │   ├── connection.py          # Подключение к БД
│   │   └── repositories.py        # Репозитории для работы с данными
│   ├── services/                   # Бизнес-логика
│   │   ├── document_service.py    # Обработка документов
│   │   ├── chat_service.py        # Чат-сервис
│   │   ├── rag_service.py         # RAG логика
│   │   └── vector_service.py      # Работа с Qdrant
│   ├── api/                       # REST API endpoints
│   │   ├── documents.py
│   │   ├── chat.py
│   │   └── health.py
│   ├── ui/                        # Gradio интерфейс
│   │   └── gradio_app.py
│   └── utils/                     # Утилиты
│       ├── text_processing.py
│       ├── file_handlers.py
│       └── logging.py
├── tests/                         # Тесты
├── alembic/                       # Миграции БД
├── docker-compose.yml             # Docker окружение
├── pyproject.toml                 # Poetry конфигурация
└── .env.example                   # Пример переменных окружения
```

## Нефункциональные требования

### Производительность
- **Время ответа чата**: < 5 секунд для простых запросов
- **Время индексации**: < 30 секунд для документа до 10MB
- **Пропускная способность**: 10 одновременных пользователей

### Надежность
- **Логирование**: все операции логируются с уровнями INFO/ERROR
- **Error handling**: graceful degradation при недоступности сервисов
- **Health checks**: для всех внешних зависимостей

### Безопасность
- **Валидация входных данных**: все пользовательские данные
- **Ограничения**: размер файлов, длина текста
- **Санитизация**: обработка загружаемых файлов

## Настройка окружения

### Порты
- **FastAPI**: 8000
- **Gradio**: 7860 (встроено в FastAPI)
- **PostgreSQL**: 5432
- **Qdrant**: 6333 (HTTP), 6334 (gRPC)

### Переменные окружения
```bash
# Azure OpenAI
AZURE_OPENAI_API_KEY=your_key
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_CHAT_DEPLOYMENT=gpt-4
AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-ada-002

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/rag_crawl

# Qdrant
QDRANT_HOST=localhost
QDRANT_PORT=6333
```

## Критерии приемки

### MVP критерии
1. ✅ Загрузка PDF и текстовых файлов через Gradio
2. ✅ Векторизация и сохранение в Qdrant
3. ✅ Базовый чат с указанием источников
4. ✅ REST API для основных операций
5. ✅ Docker Compose для локального развертывания

### Дополнительные критерии
1. ✅ Поддержка Word и Markdown файлов
2. ✅ Ресинхронизация по namespace
3. ✅ История чатов
4. ✅ Дедупликация документов
5. ✅ Интеграционные тесты

## Ограничения

### Текущая версия НЕ включает
- Аутентификацию и авторизацию
- Мультитенантность
- Масштабирование на несколько инстансов
- Интеграцию с внешними crawling сервисами
- Продвинутые алгоритмы re-ranking
- Кастомные embedding модели

## Планы развития

### Версия 0.2
- Интеграция с crawling сервисами
- Улучшенная обработка HTML контента
- Batch операции для массовой загрузки

### Версия 0.3
- Простая аутентификация
- API для внешних интеграций
- Метрики и мониторинг 