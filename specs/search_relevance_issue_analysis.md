# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞

## üìù –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º–∏ score'–∞–º–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0.6-0.8)
- –î–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –Ω–µ—Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ö–∞—á–µ—Å—Ç–≤–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –Ω–∏–∑–∫–∏–π score (< 0.3) –∏–ª–∏ –Ω–µ –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤–æ–æ–±—â–µ
- –î–æ–∫—É–º–µ–Ω—Ç—ã —Å –Ω–∏–∑–∫–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- –¢–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- Score –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é –±–ª–∏–∑–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫ –∑–∞–ø—Ä–æ—Å—É
- –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–∑–ª–∏—á–∞—Ç—å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—â–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üîç –ì–∏–ø–æ—Ç–µ–∑—ã –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–±–ª–µ–º—ã

### 1. **üö® –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –í—Ä–µ–º–µ–Ω–Ω–æ–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–º–µ—Å—Ç–æ Qdrant**

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):**
```python
def _get_vector_store(self) -> Any:
    # –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    logger.warning("–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ in-memory –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏")
    return None  # ‚ùå –°–æ–∑–¥–∞–µ—Ç SimpleVectorStore –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex):**
```python
def _get_vector_store(self) -> QdrantVectorStore:
    try:
        client = qdrant_client.QdrantClient(
            host=settings.qdrant_host,  # localhost
            port=settings.qdrant_port   # 6333
        )
        
        return QdrantVectorStore(
            client=client,
            collection_name=settings.qdrant_collection_name  # docs_v2
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Qdrant: {e}")
        raise
```

**–ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:**
- SimpleVectorStore –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–µ—Ç –∏—Å–∫–∞–∂–µ–Ω–Ω—ã–µ score'—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- Qdrant —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ docker-compose.yml –∏ config.py, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- LlamaIndex —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç Qdrant –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 1.1 **–ü—Ä–æ–±–ª–µ–º—ã —á–∞–Ω–∫–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):**
```python
# –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –æ–≥—Ä–æ–º–Ω—ã–π —á–∞–Ω–∫ –Ω–∞ –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç
chunk = DocumentChunk(
    document_id=db_document.id,
    chunk_index=0,
    content=cleaned_text,  # ‚Üê –í–ï–°–¨ –¥–æ–∫—É–º–µ–Ω—Ç —Ü–µ–ª–∏–∫–æ–º!
    vector_id=str(uuid.uuid4()),
)
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex):**
```python
from llama_index.core.ingestion import IngestionPipeline
from llama_index.core.node_parser import SentenceSplitter

pipeline = IngestionPipeline(
    transformations=[
        SentenceSplitter(
            chunk_size=settings.max_chunk_size,  # 1024
            chunk_overlap=settings.chunk_overlap  # 200
        ),
        OpenAIEmbedding(),
    ],
    vector_store=vector_store,
)
nodes = pipeline.run(documents=documents)
```

### 1.2 **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**
- `MAX_RETRIEVAL_RESULTS=3` - —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, –Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `SimilarityPostprocessor` —Å –ø–æ—Ä–æ–≥–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ù–µ—Ç reranking'–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 1.3 **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏**

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):**
```python
# –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—é–±—ã–µ 3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
query_engine = index.as_query_engine(
    similarity_top_k=3  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 3 –ª—É—á—à–∏—Ö, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã
)
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex):**
```python
from llama_index.core.postprocessor import SimilarityPostprocessor

query_engine = index.as_query_engine(
    similarity_top_k=10,  # –ü–æ–ª—É—á–∞–µ–º –±–æ–ª—å—à–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    node_postprocessors=[
        SimilarityPostprocessor(similarity_cutoff=0.75)  # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ—Ä–æ–≥—É
    ]
)
```

### 2. **–ü—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–Ω–¥–µ–∫—Å–∞**
- –ò–Ω–¥–µ–∫—Å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ë–î —á–∞–Ω–∫–æ–≤ –≤ LlamaIndex –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö namespace'–æ–≤ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ reranking'–∞**

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex):**
```python
# –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π + keyword-based)
vector_store = QdrantVectorStore(
    client=client,
    collection_name="docs_v2",
    enable_hybrid=True,  # BM25 + –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    fastembed_sparse_model="Qdrant/bm25"
)

query_engine = index.as_query_engine(
    vector_store_query_mode="hybrid",
    sparse_top_k=5,      # keyword-based —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    similarity_top_k=5,  # —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    hybrid_top_k=3       # —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
)
```

## üß™ –ü–ª–∞–Ω –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### 1.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
grep -E "(MAX_RETRIEVAL_RESULTS|MAX_CHUNK_SIZE|CHUNK_OVERLAP)" .env

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª–∏ Azure OpenAI
grep -E "(AZURE_OPENAI.*MODEL|AZURE_OPENAI.*DEPLOYMENT)" .env

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Qdrant
grep -E "(QDRANT_HOST|QDRANT_PORT|QDRANT_COLLECTION)" .env

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Qdrant –∑–∞–ø—É—â–µ–Ω
curl -f http://localhost:6333/health || echo "‚ùå Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
docker ps | grep qdrant || echo "‚ùå Qdrant –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
```

#### 1.2 –ê–Ω–∞–ª–∏–∑ –∏–Ω–¥–µ–∫—Å–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
psql $DATABASE_URL

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —á–∞–Ω–∫–æ–≤
SELECT 
    namespace,
    COUNT(*) as documents_count,
    AVG(chunks_count) as avg_chunks_per_doc,
    SUM(chunks_count) as total_chunks
FROM documents 
WHERE is_active = true 
GROUP BY namespace;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã —á–∞–Ω–∫–æ–≤
SELECT 
    d.title,
    d.namespace,
    dc.chunk_index,
    LENGTH(dc.content) as chunk_length,
    dc.content[:100] as content_preview
FROM document_chunks dc
JOIN documents d ON dc.document_id = d.id
WHERE d.is_active = true
ORDER BY chunk_length DESC
LIMIT 10;
```

#### 1.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è vector store
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ llama_service.py –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex)
def diagnose_vector_store_setup():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è in-memory –≤–º–µ—Å—Ç–æ Qdrant"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ config.py
    logger.info(f"QDRANT_HOST: {settings.qdrant_host}")
    logger.info(f"QDRANT_PORT: {settings.qdrant_port}")
    logger.info(f"QDRANT_COLLECTION: {settings.qdrant_collection_name}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Qdrant (–ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
    try:
        client = qdrant_client.QdrantClient(
            host=settings.qdrant_host,
            port=settings.qdrant_port
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        collections_info = client.get_collections()
        logger.info(f"‚úÖ Qdrant –¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–ª–ª–µ–∫—Ü–∏–∏: {collections_info}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
        if settings.qdrant_collection_name in [c.name for c in collections_info.collections]:
            collection_info = client.get_collection(settings.qdrant_collection_name)
            logger.info(f"‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è {settings.qdrant_collection_name} –Ω–∞–π–¥–µ–Ω–∞: {collection_info}")
        else:
            logger.warning(f"‚ö†Ô∏è –ö–æ–ª–ª–µ–∫—Ü–∏—è {settings.qdrant_collection_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            
        return True
    except Exception as e:
        logger.error(f"‚ùå Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
        return False

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è QdrantVectorStore
def diagnose_current_vector_store():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–æ–π vector store —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"""
    vector_store = self._get_vector_store()
    
    if vector_store is None:
        logger.error("‚ùå vector_store = None -> –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω SimpleVectorStore")
        return "SimpleVectorStore"
    elif isinstance(vector_store, QdrantVectorStore):
        logger.info(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è QdrantVectorStore: {vector_store}")
        return "QdrantVectorStore"
    else:
        logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø vector store: {type(vector_store)}")
        return type(vector_store).__name__

# –í—ã–∑–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–∞
diagnose_vector_store_setup()
diagnose_current_vector_store()
```

#### 1.4 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ llama_service.py –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
import logging
logging.basicConfig(level=logging.DEBUG)

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
async def diagnostic_query(question: str, namespace: str = "default"):
    index = self._get_index(namespace)
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
    logger.info(f"Index type: {type(index)}")
    logger.info(f"Index storage context: {type(index.storage_context)}")
    
    # –°–æ–∑–¥–∞–µ–º query engine —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    query_engine = index.as_query_engine(
        similarity_top_k=10,  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        verbose=True
    )
    
    response = query_engine.query(question)
    
    # –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if hasattr(response, 'source_nodes'):
        for i, node in enumerate(response.source_nodes):
            logger.info(f"Node {i}: score={getattr(node, 'score', 'N/A')}")
            logger.info(f"  Title: {node.metadata.get('title', 'Unknown')}")
            logger.info(f"  Content preview: {node.text[:200]}...")
            logger.info(f"  Metadata: {node.metadata}")
    
    return response
```

### –≠—Ç–∞–ø 2: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
mkdir -p test_docs

# –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ OKR (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π)
cat > test_docs/okr_guide.txt << 'EOF'
OKR (Objectives and Key Results) - —ç—Ç–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª—è–º–∏.
Objectives - —ç—Ç–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º–∏.
Key Results - —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.
OKR –ø–æ–º–æ–≥–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏—è–º —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∂–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö.
EOF

# –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (README)
cat > test_docs/readme.txt << 'EOF'
# –ü—Ä–æ–µ–∫—Ç RAG Crawl
–≠—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Docker.
–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Python –∏ FastAPI.
–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.
EOF
```

#### 2.2 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ API
curl -X POST "http://localhost:8000/api/documents/upload" \
  -F "file=@test_docs/okr_guide.txt" \
  -F "namespace=test"

curl -X POST "http://localhost:8000/api/documents/upload" \
  -F "file=@test_docs/readme.txt" \
  -F "namespace=test"

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å
curl -X POST "http://localhost:8000/api/chat" \
  -H "Content-Type: application/json" \
  -d '{"message": "–ß—Ç–æ —Ç–∞–∫–æ–µ OKR?", "namespace": "test"}' \
  | jq '.'
```

### –≠—Ç–∞–ø 3: –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ embedding'–æ–≤

#### 3.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ embedding'–æ–≤
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ diagnostic —Ñ—É–Ω–∫—Ü–∏—é
async def test_embeddings():
    embed_model = self.embed_model
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã
    okr_text = "OKR —ç—Ç–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª—è–º–∏"
    readme_text = "–ü—Ä–æ–µ–∫—Ç RAG Crawl –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    query_text = "–ß—Ç–æ —Ç–∞–∫–æ–µ OKR?"
    
    # –ü–æ–ª—É—á–∞–µ–º embedding'–∏
    query_embed = await embed_model.aget_text_embedding(query_text)
    okr_embed = await embed_model.aget_text_embedding(okr_text)
    readme_embed = await embed_model.aget_text_embedding(readme_text)
    
    # –í—ã—á–∏—Å–ª—è–µ–º cosine similarity
    import numpy as np
    
    def cosine_similarity(a, b):
        return np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))
    
    okr_sim = cosine_similarity(query_embed, okr_embed)
    readme_sim = cosine_similarity(query_embed, readme_embed)
    
    logger.info(f"Query-OKR similarity: {okr_sim}")
    logger.info(f"Query-README similarity: {readme_sim}")
    
    return {"okr_similarity": okr_sim, "readme_similarity": readme_sim}
```

#### 3.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞–Ω–∫–∏–Ω–≥–∞
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ LlamaIndex —Ä–∞–∑–±–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã
async def test_chunking():
    from llama_index.core.node_parser import SentenceSplitter
    
    splitter = SentenceSplitter(
        chunk_size=settings.max_chunk_size,
        chunk_overlap=settings.chunk_overlap
    )
    
    test_text = "..." # –ë–æ–ª—å—à–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç
    
    # –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∏ —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —á–∞–Ω–∫–∏
    doc = Document(text=test_text)
    nodes = splitter.get_nodes_from_documents([doc])
    
    logger.info(f"Text length: {len(test_text)}")
    logger.info(f"Number of chunks: {len(nodes)}")
    
    for i, node in enumerate(nodes):
        logger.info(f"Chunk {i}: length={len(node.text)}")
        logger.info(f"  Preview: {node.text[:100]}...")
```

### –≠—Ç–∞–ø 4: –ê–Ω–∞–ª–∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

#### 4.1 –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
```python
async def diagnose_vector_store():
    index = self._get_index("test")
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    logger.info(f"Vector store type: {type(index.vector_store)}")
    logger.info(f"Storage context: {type(index.storage_context)}")
    
    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    try:
        # –î–ª—è SimpleVectorStore
        if hasattr(index.vector_store, 'data'):
            logger.info(f"Vector store size: {len(index.vector_store.data.embedding_dict)}")
            logger.info(f"Node count: {len(index.vector_store.data.text_id_to_ref_doc_id)}")
    except Exception as e:
        logger.warning(f"Cannot get vector store stats: {e}")
```

#### 4.2 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Qdrant
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Qdrant
curl -X GET "http://localhost:6333/collections"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
curl -X GET "http://localhost:6333/collections/documents/info"
```

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

#### 5.1 –¢–µ—Å—Ç —Å SimilarityPostprocessor
```python
# –í—Ä–µ–º–µ–Ω–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å query engine
query_engine = index.as_query_engine(
    similarity_top_k=10,
    node_postprocessors=[
        SimilarityPostprocessor(similarity_cutoff=0.5)  # –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ä–æ–≥
    ]
)
```

#### 5.2 –¢–µ—Å—Ç —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```bash
# –ò–∑–º–µ–Ω–∏—Ç—å –≤ .env
echo "MAX_RETRIEVAL_RESULTS=10" >> .env

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```

#### 5.3 –¢–µ—Å—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —á–∞–Ω–∫–∏–Ω–≥–æ–º
```python
# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å upload_document –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —á–∞–Ω–∫–∏–Ω–≥–∞
llama_doc = Document(text=cleaned_text, metadata=rich_metadata)

# –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞–Ω–∫–∏ –≤—Ä—É—á–Ω—É—é, –ø–æ–∑–≤–æ–ª–∏—Ç—å LlamaIndex –¥–µ–ª–∞—Ç—å —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
index.insert(llama_doc)
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- **Precision@3**: –î–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–ø-3
- **Recall@10**: –î–æ–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **Average Score**: –°—Ä–µ–¥–Ω–∏–π score —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö vs –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö
- **Score Distribution**: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ score'–æ–≤ –ø–æ —Ç–∏–ø–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- **Manual Relevance**: –†—É—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **User Satisfaction**: –°—É–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
- **False Positives**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. **–ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç score < 0.3**
2. **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç score > 0.7**
3. **README —Ñ–∞–π–ª –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É "OKR"**
4. **–°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏**
5. **Precision@3 > 80% –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –Ω–∞–±–æ—Ä–µ**

## üöÄ –ü–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex)

### 1. **üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Qdrant**

**–®–∞–≥ 1.1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å `_get_vector_store()` –≤ `llama_service.py`
```python
def _get_vector_store(self) -> QdrantVectorStore:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ Qdrant –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex)."""
    try:
        client = qdrant_client.QdrantClient(
            host=settings.qdrant_host,    # localhost
            port=settings.qdrant_port     # 6333
        )
        
        return QdrantVectorStore(
            client=client,
            collection_name=settings.qdrant_collection_name  # docs_v2
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Qdrant: {e}")
        raise
```

**–®–∞–≥ 1.2:** –û–±–Ω–æ–≤–∏—Ç—å `_get_index()` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è StorageContext
```python
def _get_index(self, namespace: str) -> VectorStoreIndex:
    if namespace not in self._indices:
        vector_store = self._get_vector_store()
        storage_context = StorageContext.from_defaults(vector_store=vector_store)
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        try:
            self._indices[namespace] = VectorStoreIndex.from_vector_store(
                vector_store=vector_store,
                storage_context=storage_context
            )
        except:
            # –ï—Å–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
            self._indices[namespace] = VectorStoreIndex(
                [],
                storage_context=storage_context
            )
    
    return self._indices[namespace]
```

### 2. **HIGH PRIORITY: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ —Å IngestionPipeline**

**–®–∞–≥ 2.1:** –ó–∞–º–µ–Ω–∏—Ç—å —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –Ω–∞ IngestionPipeline
```python
async def upload_document(self, file: UploadFile, namespace: str = "default") -> DBDocument:
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    text_content = await extract_text_from_file(file)
    cleaned_text = clean_text(text_content)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ LlamaIndex –¥–æ–∫—É–º–µ–Ω—Ç–∞
    llama_doc = Document(
        text=cleaned_text,
        metadata={
            "title": title,
            "source_type": source_type,
            "namespace": namespace,
            "filename": file.filename,
        }
    )
    
    # –ü–æ–ª—É—á–∞–µ–º vector store –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º IngestionPipeline
    vector_store = self._get_vector_store()
    
    pipeline = IngestionPipeline(
        transformations=[
            SentenceSplitter(
                chunk_size=settings.max_chunk_size,      # 1024
                chunk_overlap=settings.chunk_overlap      # 200
            ),
            self.embed_model,  # Azure OpenAI embedding
        ],
        vector_store=vector_store,
    )
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ pipeline
    nodes = pipeline.run(documents=[llama_doc])
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (—É–ø—Ä–æ—â–µ–Ω–Ω–æ, –±–µ–∑ —Ä—É—á–Ω—ã—Ö —á–∞–Ω–∫–æ–≤)
    db_document = DBDocument(
        title=title,
        source_type=source_type, 
        namespace=namespace,
        chunks_count=len(nodes),
        # vector_id –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω - Qdrant —É–ø—Ä–∞–≤–ª—è–µ—Ç ID –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    )
    
    self.db.add(db_document)
    self.db.commit()
    
    return db_document
```

### 3. **HIGH PRIORITY: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏**

**–®–∞–≥ 3.1:** –û–±–Ω–æ–≤–∏—Ç—å query engine —Å SimilarityPostprocessor
```python
def _get_query_engine(self, namespace: str):
    index = self._get_index(namespace)
    
    return index.as_query_engine(
        similarity_top_k=10,  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        node_postprocessors=[
            SimilarityPostprocessor(similarity_cutoff=0.75)  # –§–∏–ª—å—Ç—Ä —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        ]
    )
```

### 4. **MEDIUM PRIORITY: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å Hybrid Search**

**–®–∞–≥ 4.1:** –í–∫–ª—é—á–∏—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π + BM25)
```python
def _get_vector_store(self) -> QdrantVectorStore:
    client = qdrant_client.QdrantClient(
        host=settings.qdrant_host,
        port=settings.qdrant_port
    )
    
    return QdrantVectorStore(
        client=client,
        collection_name=settings.qdrant_collection_name,
        enable_hybrid=True,  # –í–∫–ª—é—á–∞–µ–º BM25 + –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
        fastembed_sparse_model="Qdrant/bm25"
    )

def _get_query_engine(self, namespace: str):
    index = self._get_index(namespace)
    
    return index.as_query_engine(
        vector_store_query_mode="hybrid",
        sparse_top_k=5,      # BM25 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        similarity_top_k=5,  # –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã  
        hybrid_top_k=3,      # –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        node_postprocessors=[
            SimilarityPostprocessor(similarity_cutoff=0.70)
        ]
    )
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **Qdrant –≤–º–µ—Å—Ç–æ SimpleVectorStore** ‚Üí –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ score'—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
2. **SentenceSplitter –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞** ‚Üí –õ—É—á—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
3. **SimilarityPostprocessor** ‚Üí –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. **Hybrid Search** ‚Üí –ï—â–µ –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö score'–æ–≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ Qdrant.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –≠—Ç–∞–ø 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ pyproject.toml:
# ‚úÖ llama-index = "^0.12.0"
# ‚úÖ qdrant-client = "^1.6.0" 
# ‚úÖ llama-index-vector-stores-qdrant = "^0.6.1"
# ‚úÖ llama-index-embeddings-azure-openai = "^0.3.8"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
poetry show | grep -E "(llama-index|qdrant)"

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:
poetry install
```

### –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Qdrant
```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Qdrant –∑–∞–ø—É—â–µ–Ω
docker ps | grep qdrant

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
curl -f http://localhost:6333/health

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–∏
curl "http://localhost:6333/collections"
```

### –≠—Ç–∞–ø 2: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
test_docs = [
    {"title": "–°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞", "content": "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞..."},
    {"title": "–û–±—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç", "content": "–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."}
]

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ API
for doc in test_docs:
    response = requests.post("http://localhost:8000/api/documents/upload", 
                           files={"file": doc["content"]})

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é —Ç–µ–º—É
response = requests.post("http://localhost:8000/api/chat",
                        json={"message": "–î–µ—Ç–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–π —Ç–µ–º–µ", "namespace": "test"})

print(f"–û—Ç–≤–µ—Ç: {response.json()['response']}")
print(f"–ò—Å—Ç–æ—á–Ω–∏–∫–∏: {response.json()['sources']}")

# –û–∂–∏–¥–∞–µ–º: —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
```

### –≠—Ç–∞–ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
1. ‚úÖ –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è QdrantVectorStore"
2. ‚úÖ –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. ‚úÖ Score —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ > 0.75
4. ‚úÖ Score –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ < 0.3 (–∏–ª–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤–æ–æ–±—â–µ)
5. ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ

### –≠—Ç–∞–ø 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞
```python
# –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞
async def query_with_quality_metrics(self, question: str, namespace: str):
    response = await self.query(question, namespace)
    
    # –õ–æ–≥–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
    sources = response.get('sources', [])
    scores = [s.get('score', 0) for s in sources]
    
    logger.info(f"Query: {question}")
    logger.info(f"Sources count: {len(sources)}")
    logger.info(f"Scores: {scores}")
    logger.info(f"Min score: {min(scores) if scores else 0}")
    logger.info(f"Max score: {max(scores) if scores else 0}")
    
    return response
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ –∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –¶–µ–ª—å |
|---------|---------------|-------------------|------|
| Vector Store | SimpleVectorStore | QdrantVectorStore | ‚úÖ |
| –ß–∞–Ω–∫–∏–Ω–≥ | 1 —á–∞–Ω–∫ = –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç | SentenceSplitter | ‚úÖ |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è | –ù–µ—Ç | SimilarityPostprocessor | ‚úÖ |
| –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | –í—ã—Å–æ–∫–∏–π score (0.6-0.8) | < 0.3 –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç | ‚úÖ |
| –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | –í–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è | > 0.75 | ‚úÖ |

---

---

## üìã –ò–¢–û–ì–û–í–´–ô SUMMARY

### üö® **–ì–ª–∞–≤–Ω–∞—è –Ω–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
**–ö–æ–¥ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–º–µ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ Qdrant**

```python
# ‚ùå –¢–ï–ö–£–©–ò–ô –ö–û–î (—Å—Ç—Ä–æ–∫–∞ 118 –≤ llama_service.py):
def _get_vector_store(self) -> Any:
    return None  # –°–æ–∑–¥–∞–µ—Ç SimpleVectorStore –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

# ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨ (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex):
def _get_vector_store(self) -> QdrantVectorStore:
    client = qdrant_client.QdrantClient(host="localhost", port=6333)
    return QdrantVectorStore(client=client, collection_name="docs_v2")
```

### üéØ **–ü–æ—á–µ–º—É —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é:**
1. **SimpleVectorStore** –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
2. **In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** –¥–∞–µ—Ç –∏—Å–∫–∞–∂–µ–Ω–Ω—ã–µ score'—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
3. **Qdrant** –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º
4. **LlamaIndex –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç** Qdrant –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### üìä **–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚ùå –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º score ‚Üí ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ score'—ã –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚ùå –û–¥–∏–Ω –±–æ–ª—å—à–æ–π —á–∞–Ω–∫ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ SentenceSplitter  
- ‚ùå –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ ‚Üí ‚úÖ SimilarityPostprocessor(cutoff=0.75)
- ‚ùå –¢–æ–ª—å–∫–æ 3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Üí ‚úÖ 10 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

### üîß **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å `_get_vector_store()`** - –∑–∞–º–µ–Ω–∏—Ç—å `return None` –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
2. **–î–æ–±–∞–≤–∏—Ç—å SimilarityPostprocessor** - —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –ø–æ—Ä–æ–≥—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SentenceSplitter** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ –≤–º–µ—Å—Ç–æ —Ü–µ–ª–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

### ‚úÖ **–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ Qdrant –∑–∞–ø—É—â–µ–Ω –≤ docker-compose.yml 
- ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ pyproject.toml
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –≤ config.py
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ LlamaIndex

**–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:** –ü—Ä–æ–±–ª–µ–º–∞ –≤—ã–∑–≤–∞–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ SimpleVectorStore –≤–º–µ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ Qdrant. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–π–º–µ—Ç ~1 —á–∞—Å –∏ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞. 